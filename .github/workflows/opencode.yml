name: OpenCode Agent (Windows self-hosted, Python)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: opencode-issue-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  opencode_from_issue_comment:
    if: contains(github.event.comment.body, '/oc') && github.event.issue.pull_request == null && (github.event.comment.author_association == 'OWNER' || github.event.comment.author_association == 'MEMBER' || github.event.comment.author_association == 'COLLABORATOR')

    runs-on: [self-hosted, Windows, X64, home-desktop]
    timeout-minutes: 45

    steps:
      - name: Checkout default branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Node (for OpenCode)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Ensure OpenCode installed
        shell: powershell
        run: |
          if (-not (Get-Command opencode -ErrorAction SilentlyContinue)) {
            npm i -g opencode-ai
          }
          opencode --version

      - name: Configure git identity
        shell: powershell
        run: |
          git config user.name "opencode-bot"
          git config user.email "opencode-bot@users.noreply.github.com"

      - name: Create work branch
        id: branch
        shell: powershell
        run: |
          $branch = "oc/issue-${{ github.event.issue.number }}-${{ github.run_id }}"
          git checkout -b $branch
          "branch=$branch" >> $env:GITHUB_OUTPUT

      - name: Prepare Python env (venv + deps)
        shell: powershell
        run: |
          python -m venv .venv
          .\.venv\Scripts\python -m pip install --upgrade pip
          if (Test-Path "pyproject.toml") {
            .\.venv\Scripts\python -m pip install -e .
          } elseif (Test-Path "requirements.txt") {
            .\.venv\Scripts\python -m pip install -r requirements.txt
          } elseif (Test-Path "setup.py") {
            .\.venv\Scripts\python -m pip install -e .
          } else {
            Write-Host "No pyproject/requirements/setup found. Skipping dependency install."
          }
          .\.venv\Scripts\python -m pip install pytest

      - name: Run agent task
        id: agent
        shell: powershell
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          REPO: ${{ github.repository }}
        run: |
          $instruction = $env:COMMENT_BODY -replace '(?s)^.*?/oc\s*', ''
          $instruction = $instruction.Trim()
          if ([string]::IsNullOrWhiteSpace($instruction)) {
            $instruction = "Resolve this issue. Commit changes and run tests, then create a summary report."
          }
          $nl = [Environment]::NewLine
          $prompt = "You are a Python coding agent for repository ($env:REPO). Resolve the issue below." + $nl + $nl
          $prompt += "[Issue #$env:ISSUE_NUMBER] $env:ISSUE_TITLE" + $nl
          $prompt += "=== Issue Body ===" + $nl
          $prompt += "$env:ISSUE_BODY" + $nl
          $prompt += "==================" + $nl + $nl
          $prompt += "[User instruction]" + $nl
          $prompt += "$instruction" + $nl + $nl
          $prompt += "Requirements:" + $nl
          $prompt += "1) Minimal changes only (no unnecessary reformatting)." + $nl
          $prompt += "2) Run tests using Windows venv: .venv\Scripts\python -m pytest -q" + $nl
          $prompt += "3) Save test results to pytest_output.txt" + $nl
          $prompt += "4) Create opencode_report.md with: summary, changed files, commands run, test results, risks" + $nl
          $prompt += "5) Ensure git diff shows changes at the end."
          opencode run "$prompt"
          $exitCode = $LASTEXITCODE
          Write-Host "OpenCode exit code: $exitCode"
          if (Test-Path ".\.venv\Scripts\python.exe") {
            .\.venv\Scripts\python -m pytest -q 2>&1 | Tee-Object -FilePath "pytest_output.txt"
            Write-Host "Pytest completed (exit code may vary based on tests)"
          } else {
            "venv not found; pytest skipped." | Out-File -Encoding UTF8 "pytest_output.txt"
          }
          $LASTEXITCODE = 0
          if (-not (Test-Path "opencode_report.md")) {
            $fallback = "# OpenCode Report (fallback)" + $nl + $nl
            $fallback += "- Issue: #$env:ISSUE_NUMBER $env:ISSUE_TITLE" + $nl
            $fallback += "- Instruction: $instruction" + $nl + $nl
            $fallback += "(Agent did not create opencode_report.md. Check Actions log and pytest_output.txt.)"
            $fallback | Out-File -Encoding UTF8 "opencode_report.md"
          }
          $tail = ""
          if (Test-Path "pytest_output.txt") {
            $tail = (Get-Content "pytest_output.txt" -Tail 80) -join $nl
          }
          $appendText = $nl + "====" + $nl + "## Pytest log (tail)" + $nl + "``````text" + $nl + $tail + $nl + "``````"
          Add-Content -Encoding UTF8 "opencode_report.md" $appendText

      - name: Commit and push changes (if any)
        id: commit
        shell: powershell
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git add -A
          $status = git status --porcelain
          if ([string]::IsNullOrWhiteSpace($status)) {
            echo "no_changes=true" >> $env:GITHUB_OUTPUT
            exit 0
          }
          git commit -m "OpenCode: resolve issue #${{ github.event.issue.number }}"
          git push -u origin ${{ steps.branch.outputs.branch }}
          echo "no_changes=false" >> $env:GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.commit.outputs.no_changes == 'false'
        id: cpr
        shell: powershell
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $prUrl = gh pr create --title "OpenCode: Issue #${{ github.event.issue.number }} - ${{ github.event.issue.title }}" --body "Closes #${{ github.event.issue.number }}`n`n## OpenCode summary`n- Full report: opencode_report.md`n- Test log: pytest_output.txt" --base main 2>&1
          echo "pr_url=$prUrl" >> $env:GITHUB_OUTPUT

      - name: Comment back to Issue with PR + summary
        if: steps.commit.outputs.no_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('opencode_report.md', 'utf8');
            const preview = report.length > 3500 ? report.slice(0, 3500) + "\n\n...(truncated)" : report;
            const prUrl = `${{ steps.cpr.outputs.pr_url }}`;
            const body = `OpenCode completed: PR created\n\n- PR: ${prUrl}\n\n=== Report Preview ===\n\`\`\`\n${preview}\n\`\`\``;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body
            });

      - name: Comment back to Issue (no changes)
        if: steps.commit.outputs.no_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: "OpenCode ran but no changes to commit. The instruction may be too abstract or already resolved. Check Actions log/pytest_output.txt/opencode_report.md."
            });
